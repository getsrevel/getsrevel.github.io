<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.88.1">
<meta name=description content>
<link rel=icon href=/images/favicon.png type=image/png>
<title>Webrtc Server :: Getsrevel</title>
<link href=/css/nucleus.css?1634592699 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1634592699 rel=stylesheet>
<link href=/css/hybrid.css?1634592699 rel=stylesheet>
<link href=/css/featherlight.min.css?1634592699 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1634592699 rel=stylesheet>
<link href=/css/auto-complete.css?1634592699 rel=stylesheet>
<link href=/css/atom-one-dark-reasonable.css?1634592699 rel=stylesheet>
<link href=/css/theme.css?1634592699 rel=stylesheet>
<link href=/css/tabs.css?1634592699 rel=stylesheet>
<link href=/css/hugo-theme.css?1634592699 rel=stylesheet>
<link href=/css/theme-getsrevel.css?1634592699 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1634592699></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158806272-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-158806272-1')</script>
</head>
<body data-url=/tech/node/webrtc-server/>
<nav id=sidebar>
<div id=header-wrapper>
<div id=header>
<a id=logo href=/><svg xmlns="http://www.w3.org/2000/svg" style="background-color:transparent;width:100%;height:100%;fill:#ededed;fill-rule:nonzero" viewBox="0 0 180 50"><text id="_GR_" data-name="{GR}" transform="translate(40 38)" font-size="3em" font-family="Supermercado One"><tspan x="0" y="0">{GR}</tspan></text></svg>
</a>
</div>
<div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div>
<script type=text/javascript src=/js/lunr.min.js?1634592699></script>
<script type=text/javascript src=/js/auto-complete.js?1634592699></script>
<script type=text/javascript>var baseurl="https://getsrevel.github.io/"</script>
<script type=text/javascript src=/js/search.js?1634592699></script>
</div>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=/project/ title=Project class=dd-item>
<a href=/project/>
Project
</a>
<ul>
<li data-nav-id=/project/html-basics/ title="HTML Basics" class=dd-item>
<a href=/project/html-basics/>
HTML Basics
</a>
</li>
<li data-nav-id=/project/mastermind/ title=Mastermind class=dd-item>
<a href=/project/mastermind/>
Mastermind
</a>
</li>
<li data-nav-id=/project/rock-paper-scissor/ title="Rock Paper Scissor" class=dd-item>
<a href=/project/rock-paper-scissor/>
Rock Paper Scissor
</a>
</li>
<li data-nav-id=/project/shuffle-n-sort/ title="Shuffle & Sort" class=dd-item>
<a href=/project/shuffle-n-sort/>
Shuffle & Sort
</a>
</li>
<li data-nav-id=/project/game-of-life/ title="John Conway's: Game of life" class=dd-item>
<a href=/project/game-of-life/>
Game of Life
</a>
</li>
<li data-nav-id=/project/volapyk-dansk/ title=Volapyk-dansk class=dd-item>
<a href=/project/volapyk-dansk/>
Volapyk-dansk
</a>
</li>
<li data-nav-id=/project/mobile-game/ title="Mobile Game" class=dd-item>
<a href=/project/mobile-game/>
Mobile Game
</a>
</li>
<li data-nav-id=/project/code-lock/ title="Code Lock" class=dd-item>
<a href=/project/code-lock/>
Code Lock
</a>
</li>
<li data-nav-id=/project/server-controlled-leds/ title="Styring af LED via web interface" class=dd-item>
<a href=/project/server-controlled-leds/>
Server Controlled LEDs
</a>
</li>
<li data-nav-id=/project/weather-station/ title="Weather Station" class=dd-item>
<a href=/project/weather-station/>
Weather Station
</a>
</li>
<li data-nav-id=/project/asteroid/ title="Asteroids Game" class=dd-item>
<a href=/project/asteroid/>
Asteroids Game
</a>
</li>
<li data-nav-id=/project/recursion/ title=Rekursion class=dd-item>
<a href=/project/recursion/>
Rekursion
</a>
</li>
<li data-nav-id=/project/stickman/ title=Stickman class=dd-item>
<a href=/project/stickman/>
Stickman
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/ title=Tech class="dd-item
parent">
<a href=/tech/>
Tech
</a>
<ul>
<li data-nav-id=/tech/html/ title=Html class=dd-item>
<a href=/tech/html/>
Html
</a>
</li>
<li data-nav-id=/tech/css/ title=Css class=dd-item>
<a href=/tech/css/>
Css
</a>
<ul>
<li data-nav-id=/tech/css/flexbox-layout/ title="Flexbox Layout" class=dd-item>
<a href=/tech/css/flexbox-layout/>
Flexbox Layout
</a>
</li>
<li data-nav-id=/tech/css/grid-layout/ title="Grid Layout" class=dd-item>
<a href=/tech/css/grid-layout/>
Grid Layout
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/unity/ title=Unity class=dd-item>
<a href=/tech/unity/>
Unity
</a>
<ul>
<li data-nav-id=/tech/unity/unity-basics/ title="Unity Basics" class=dd-item>
<a href=/tech/unity/unity-basics/>
Unity Basics
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/arduino/ title=Arduino class=dd-item>
<a href=/tech/arduino/>
Arduino
</a>
<ul>
<li data-nav-id=/tech/arduino/button-trigger/ title="Button Trigger" class=dd-item>
<a href=/tech/arduino/button-trigger/>
Button Trigger
</a>
</li>
<li data-nav-id=/tech/arduino/neopixel/ title=Neopixel class=dd-item>
<a href=/tech/arduino/neopixel/>
Neopixel
</a>
</li>
<li data-nav-id=/tech/arduino/hex-string/ title="Hex String" class=dd-item>
<a href=/tech/arduino/hex-string/>
Hex String
</a>
</li>
<li data-nav-id=/tech/arduino/json-command-receiver/ title="Json Command Receiver" class=dd-item>
<a href=/tech/arduino/json-command-receiver/>
Json Command Receiver
</a>
</li>
<li data-nav-id=/tech/arduino/task-loop-functions/ title="Task Loop using Function Pointers" class=dd-item>
<a href=/tech/arduino/task-loop-functions/>
Task Loop
</a>
</li>
<li data-nav-id=/tech/arduino/json-beacon/ title="Json Beacon" class=dd-item>
<a href=/tech/arduino/json-beacon/>
Json Beacon
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/c-sharp/ title=C# class=dd-item>
<a href=/tech/c-sharp/>
C#
</a>
<ul>
<li data-nav-id=/tech/c-sharp/c-sharp-intro/ title="C# Intro" class=dd-item>
<a href=/tech/c-sharp/c-sharp-intro/>
C# Intro
</a>
</li>
<li data-nav-id=/tech/c-sharp/temperature-assessment/ title="Temperature Assessment" class=dd-item>
<a href=/tech/c-sharp/temperature-assessment/>
Temperature Assessment
</a>
</li>
<li data-nav-id=/tech/c-sharp/guessing-game/ title="Guessing Game" class=dd-item>
<a href=/tech/c-sharp/guessing-game/>
Guessing Game
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/react/ title=React class=dd-item>
<a href=/tech/react/>
React
</a>
<ul>
<li data-nav-id=/tech/react/react-intro/ title="React Intro" class=dd-item>
<a href=/tech/react/react-intro/>
React Intro
</a>
</li>
<li data-nav-id=/tech/react/component-props/ title="Components + Data" class=dd-item>
<a href=/tech/react/component-props/>
Components + Data
</a>
</li>
<li data-nav-id=/tech/react/react-with-firebase/ title="React + Firebase" class=dd-item>
<a href=/tech/react/react-with-firebase/>
React + Firebase
</a>
</li>
<li data-nav-id=/tech/react/react-fake-weather/ title="React + Firestore Fake Weather" class=dd-item>
<a href=/tech/react/react-fake-weather/>
Fake Weather
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/chartjs/ title=Chart.js class=dd-item>
<a href=/tech/chartjs/>
Chart.js
</a>
</li>
<li data-nav-id=/tech/firebase/ title=Firebase class=dd-item>
<a href=/tech/firebase/>
Firebase
</a>
<ul>
<li data-nav-id=/tech/firebase/firestore-client/ title="Firestore Client" class=dd-item>
<a href=/tech/firebase/firestore-client/>
Firestore Client
</a>
</li>
<li data-nav-id=/tech/firebase/firestore-upload/ title="Firestore Node Upload" class=dd-item>
<a href=/tech/firebase/firestore-upload/>
Firestore Upload
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/regex/ title=Regex class=dd-item>
<a href=/tech/regex/>
Regex
</a>
</li>
<li data-nav-id=/tech/mindstorms/ title=Mindstorms class=dd-item>
<a href=/tech/mindstorms/>
Mindstorms
</a>
</li>
<li data-nav-id=/tech/hugo/ title="Hugo Static Site Generator" class=dd-item>
<a href=/tech/hugo/>
Hugo
</a>
</li>
<li data-nav-id=/tech/node/ title=Node.js class="dd-item
parent">
<a href=/tech/node/>
Node.js
</a>
<ul>
<li data-nav-id=/tech/node/intro/ title=Intro class=dd-item>
<a href=/tech/node/intro/>
Intro
</a>
</li>
<li data-nav-id=/tech/node/discord-bot/ title="Discord Bot" class=dd-item>
<a href=/tech/node/discord-bot/>
Discord Bot
</a>
</li>
<li data-nav-id=/tech/node/web-server/ title="Web Server" class=dd-item>
<a href=/tech/node/web-server/>
Web Server
</a>
</li>
<li data-nav-id=/tech/node/webrtc-server/ title="Webrtc Server" class="dd-item
parent
active">
<a href=/tech/node/webrtc-server/>
Webrtc Server
</a>
</li>
<li data-nav-id=/tech/node/readline-stdin/ title="Readline on Stdin" class=dd-item>
<a href=/tech/node/readline-stdin/>
Readline on Stdin
</a>
</li>
<li data-nav-id=/tech/node/serial-json/ title="Serial Json" class=dd-item>
<a href=/tech/node/serial-json/>
Serial Json
</a>
</li>
<li data-nav-id=/tech/node/socket-io-demo/ title="Socket IO" class=dd-item>
<a href=/tech/node/socket-io-demo/>
Socket IO
</a>
</li>
<li data-nav-id=/tech/node/web-scraping/ title="Web Scraping" class=dd-item>
<a href=/tech/node/web-scraping/>
Web Scraping
</a>
</li>
</ul>
</li>
<li data-nav-id=/tech/p5js/ title=p5.js class=dd-item>
<a href=/tech/p5js/>
p5.js
</a>
<ul>
<li data-nav-id=/tech/p5js/intro/ title="Intro til P5js" class=dd-item>
<a href=/tech/p5js/intro/>
Intro
</a>
</li>
<li data-nav-id=/tech/p5js/canvas/ title=Canvas class=dd-item>
<a href=/tech/p5js/canvas/>
Canvas
</a>
</li>
<li data-nav-id=/tech/p5js/circle-collision/ title="Circle Collision" class=dd-item>
<a href=/tech/p5js/circle-collision/>
Circle Collision
</a>
</li>
<li data-nav-id=/tech/p5js/shape-drawing/ title="Shape Drawing" class=dd-item>
<a href=/tech/p5js/shape-drawing/>
Shape Drawing
</a>
</li>
<li data-nav-id=/tech/p5js/nested-loops/ title="Nested Loops" class=dd-item>
<a href=/tech/p5js/nested-loops/>
Nested Loops
</a>
</li>
<li data-nav-id=/tech/p5js/map-range/ title="Map Range" class=dd-item>
<a href=/tech/p5js/map-range/>
Map Range
</a>
</li>
<li data-nav-id=/tech/p5js/logical-operators/ title="Logical Operators" class=dd-item>
<a href=/tech/p5js/logical-operators/>
Logical Operators
</a>
</li>
<li data-nav-id=/tech/p5js/ball-bounce/ title="Ball Bounce" class=dd-item>
<a href=/tech/p5js/ball-bounce/>
Ball Bounce
</a>
</li>
<li data-nav-id=/tech/p5js/random-color/ title="Random Color" class=dd-item>
<a href=/tech/p5js/random-color/>
Random Color
</a>
</li>
<li data-nav-id=/tech/p5js/times-table/ title="Times Table" class=dd-item>
<a href=/tech/p5js/times-table/>
Times Table
</a>
</li>
<li data-nav-id=/tech/p5js/key-pressed-multi/ title="Key Press Multi" class=dd-item>
<a href=/tech/p5js/key-pressed-multi/>
Key Press Multi
</a>
</li>
<li data-nav-id=/tech/p5js/key-is-pressed/ title=Keyboard class=dd-item>
<a href=/tech/p5js/key-is-pressed/>
Keyboard
</a>
</li>
<li data-nav-id=/tech/p5js/fullscreen-toggle/ title="Fullscreen toggle" class=dd-item>
<a href=/tech/p5js/fullscreen-toggle/>
Fullscreen toggle
</a>
</li>
<li data-nav-id=/tech/p5js/key-pressed-simple/ title="Key Pressed Simple" class=dd-item>
<a href=/tech/p5js/key-pressed-simple/>
Key Pressed Simple
</a>
</li>
<li data-nav-id=/tech/p5js/multitouch/ title=Multitouch class=dd-item>
<a href=/tech/p5js/multitouch/>
Multitouch
</a>
</li>
<li data-nav-id=/tech/p5js/polar-loop/ title="Polar Loop" class=dd-item>
<a href=/tech/p5js/polar-loop/>
Polar Loop
</a>
</li>
<li data-nav-id=/tech/p5js/polar-spinner/ title="Polar Spinner" class=dd-item>
<a href=/tech/p5js/polar-spinner/>
Polar Spinner
</a>
</li>
<li data-nav-id=/tech/p5js/tacospin/ title=Tacospin class=dd-item>
<a href=/tech/p5js/tacospin/>
Tacospin
</a>
</li>
<li data-nav-id=/tech/p5js/hsl-colors/ title="HSL Colors" class=dd-item>
<a href=/tech/p5js/hsl-colors/>
HSL Colors
</a>
</li>
<li data-nav-id=/tech/p5js/stickman-demo/ title="Stickman Objects" class=dd-item>
<a href=/tech/p5js/stickman-demo/>
Stickman Objects
</a>
</li>
<li data-nav-id=/tech/p5js/sound/ title=Sound class=dd-item>
<a href=/tech/p5js/sound/>
Sound
</a>
</li>
</ul>
</li>
</ul>
</li>
<li data-nav-id=/tools/ title=Tools class=dd-item>
<a href=/tools/>
Tools
</a>
<ul>
<li data-nav-id=/tools/command-line/ title="Command Line Basics" class=dd-item>
<a href=/tools/command-line/>
Command Line
</a>
</li>
<li data-nav-id=/tools/development-model/ title="Iterativ udvikling" class=dd-item>
<a href=/tools/development-model/>
Iterativ udvikling
</a>
</li>
<li data-nav-id=/tools/code-editor/ title="Code Editors and IDE's" class=dd-item>
<a href=/tools/code-editor/>
Editors and IDE's
</a>
</li>
<li data-nav-id=/tools/git/ title="Git Intro" class=dd-item>
<a href=/tools/git/>
Git Intro
</a>
</li>
</ul>
</li>
</ul>
<section id=footer>
<p>&copy; 2019 - 2021</p>
</section>
</div>
</nav>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
<a href=/>Getsrevel</a> > <a href=/tech/>Tech</a> > <a href=/tech/node/>Node.js</a> > Webrtc Server
</span>
</div>
<div class=progress>
<div class=wrapper>
<nav id=TableOfContents>
<ul>
<li><a href=#opsætning-af-projekt>Opsætning af projekt</a></li>
<li><a href=#server>Server</a></li>
<li><a href=#afsender-af-video-stream>Afsender af video stream</a>
<ul>
<li><a href=#tegn-på-canvas>Tegn på canvas</a></li>
<li><a href=#styring-af-video-stream>Styring af video stream</a></li>
<li><a href=#visning-i-browser>Visning i browser</a></li>
</ul>
</li>
<li><a href=#modtager-af-video-stream>Modtager af video stream</a></li>
<li><a href=#afprøvning>Afprøvning</a>
<ul>
<li><a href=#materiale>Materiale</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=body-inner>
<h1>
Webrtc Server
</h1>
<p>Dette er eksempel viser hvordan man kan streame indholdet af et html canvas element (en <a href=https://p5js.org/>p5js sketch</a>) til en anden maskine.
Streaming delen håndteres af <a href=https://webrtc.org/>WebRTC</a>, og etablering af forbindelsen håndteres ved hjælp af <a href=http://socket.io/>Socket.io</a>.</p>
<h2 id=opsætning-af-projekt>Opsætning af projekt</h2>
<p>Først skal der laves et projekt så node kan finde ud af at køre programmet, og har en <code>package.json</code> fil til at holde styr på projektet og afhængigheder af biblioteksmoduler.</p>
<p>Start med at lave en mappe, som kan indeholde dit projekt. Kald den f.eks. <code>webrtc-server</code>.
I denne mappe skal du køre følgende kommando, for at oprette projekt filen <code>package.json</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>npm init</code></pre></div>
<p>Udfyld passende værdier som svar på de spørgsmål programmet stiller.
Jeg foreslår at ændre din main fil til <code>server.js</code>.</p>
<p>Dernæst har du mulighed for at installere disse afhængigheder.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>npm install express
npm install socket.io</code></pre></div>
<p>Indsæt en start action i script sektionen.</p>
<p>Du burde nu have en <code>package.json</code> fil, der ser nogenlunde sådan ud:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;webrtccanvasbroadcast&#34;</span>,
  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Example of streaming canvas content using WebRTC&#34;</span>,
  <span style=color:#f92672>&#34;main&#34;</span>: <span style=color:#e6db74>&#34;server.js&#34;</span>,
  <span style=color:#f92672>&#34;scripts&#34;</span>: {
    <span style=color:#f92672>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;node server.js&#34;</span>,
    <span style=color:#f92672>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;</span>
  },
  <span style=color:#f92672>&#34;author&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
  <span style=color:#f92672>&#34;license&#34;</span>: <span style=color:#e6db74>&#34;ISC&#34;</span>,
  <span style=color:#f92672>&#34;dependencies&#34;</span>: {
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&#34;express&#34;</span>: <span style=color:#e6db74>&#34;^4.17.1&#34;</span>,
</span><span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&#34;socket.io&#34;</span>: <span style=color:#e6db74>&#34;^3.1.0&#34;</span>
</span>  }
}</code></pre></div>
<p>Bemærk de to pakker der er listet under afhængigheder.</p>
<h2 id=server>Server</h2>
<p>De statiske web-resourcer placeres i mappen public, og de gøres tilgængelige på samme måde som i eksemplet med den <a href=../web-server/>simple web server</a>.</p>
<p>Derudover består serveren af en række endpoints, der håndterer socket.io beskeder.
Dette er nødvendigt for at kunne styre transmission af videostrømmen, da dette ikke er indbygget i <a href=https://webrtc.org/>WebRTC</a>.</p>
<p>Koden til serveren placeres i filen <code>server.js</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;express&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>broadcaster</span>;
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4000</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;http&#34;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#a6e22e>app</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>io</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;socket.io&#34;</span>)(<span style=color:#a6e22e>server</span>);
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#66d9ef>static</span>(<span style=color:#ae81ff>__</span><span style=color:#a6e22e>dirname</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/public&#34;</span>));

<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>e</span> =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>e</span>));

<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;connection&#34;</span>, <span style=color:#a6e22e>socket</span> =&gt; {
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;broadcaster&#34;</span>, () =&gt; {
    <span style=color:#a6e22e>broadcaster</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span>;
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Broadcaster id: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>broadcaster</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
    <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>broadcast</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;broadcaster&#34;</span>);
  });
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;watcher&#34;</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Watcher id: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
    <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>to</span>(<span style=color:#a6e22e>broadcaster</span>).<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;watcher&#34;</span>, <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span>);
  });
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;offer&#34;</span>, (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>message</span>) =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Offer id: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>, message: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
    <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>to</span>(<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;offer&#34;</span>, <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>message</span>);
  });
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;answer&#34;</span>, (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>message</span>) =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Answer id: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>, message: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
    <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>to</span>(<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;answer&#34;</span>, <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>message</span>);
  });
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;candidate&#34;</span>, (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>message</span>) =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Candidate id: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>, message: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
    <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>to</span>(<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;candidate&#34;</span>, <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>message</span>);
  });
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;disconnect&#34;</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Disconnect id: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
    <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>to</span>(<span style=color:#a6e22e>broadcaster</span>).<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;disconnectPeer&#34;</span>, <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>id</span>);
  });
});

<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>port</span>, () =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Server is running on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>port</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>));</code></pre></div>
<p>Når du ønsker at starte serveren, kan det gøres med kommandoen.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>npm start</code></pre></div>
<h2 id=afsender-af-video-stream>Afsender af video stream</h2>
<p>For at have noget at sende afsted laves en sketch ved hjælp af <a href=/tech/p5js/intro/>p5js</a>, der streames til modtagerne med <a href=https://webrtc.org/>WebRTC</a>.</p>
<h3 id=tegn-på-canvas>Tegn på canvas</h3>
<p>Der laves en sketch, der tegner noget på det canvas element, som skal transmitteres.
I eksemplet tegnes blot en rød cirkel med sort omrids på musens position.
Dette laves i filen <code>public/broadcast/sketch.js</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>stream</span>;

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setup</span>() {
  <span style=color:#75715e>// Capture the canvas content as a stream
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createCanvas</span>(<span style=color:#ae81ff>400</span>, <span style=color:#ae81ff>400</span>);
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>htmlCanvas</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elt</span>;
  <span style=color:#a6e22e>stream</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>htmlCanvas</span>.<span style=color:#a6e22e>captureStream</span>();

  <span style=color:#a6e22e>gotStream</span>(<span style=color:#a6e22e>stream</span>);
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>draw</span>() {
  <span style=color:#a6e22e>background</span>(<span style=color:#ae81ff>220</span>);
  <span style=color:#75715e>// Draw a red circle at the position of the mouse
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>fill</span>(<span style=color:#e6db74>&#39;red&#39;</span>);
  <span style=color:#a6e22e>strokeWeight</span>(<span style=color:#ae81ff>5</span>);
  <span style=color:#a6e22e>circle</span>(<span style=color:#a6e22e>mouseX</span>, <span style=color:#a6e22e>mouseY</span>, <span style=color:#ae81ff>50</span>);
}</code></pre></div>
<h3 id=styring-af-video-stream>Styring af video stream</h3>
<p>For at kunne håndtere WebRTC forbindelsen kommunikeres med serveren via <a href=http://socket.io/>Socket.io</a>.</p>
<p>Klient-delen der styrer afsendelsen laves i <code>public/broadcast/webrtc.js</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>peerConnections</span> <span style=color:#f92672>=</span> {};
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>iceServers</span><span style=color:#f92672>:</span> [
    {
      <span style=color:#e6db74>&#34;urls&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;stun:stun.l.google.com:19302&#34;</span>,
    },
  ]
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>socket</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>connect</span>(window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>origin</span>);

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;answer&#34;</span>, (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>description</span>) =&gt; {
  <span style=color:#a6e22e>peerConnections</span>[<span style=color:#a6e22e>id</span>].<span style=color:#a6e22e>setRemoteDescription</span>(<span style=color:#a6e22e>description</span>);
});

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;watcher&#34;</span>, <span style=color:#a6e22e>id</span> =&gt; {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>peerConnection</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RTCPeerConnection</span>(<span style=color:#a6e22e>config</span>);
  <span style=color:#a6e22e>peerConnections</span>[<span style=color:#a6e22e>id</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>peerConnection</span>;

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>stream</span> <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>stream</span>;
  <span style=color:#a6e22e>stream</span>.<span style=color:#a6e22e>getTracks</span>().<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>track</span> =&gt; <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>addTrack</span>(<span style=color:#a6e22e>track</span>, <span style=color:#a6e22e>stream</span>));

  <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>onicecandidate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span> =&gt; {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>candidate</span>) {
      <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;candidate&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>candidate</span>);
    }
  };

  <span style=color:#a6e22e>peerConnection</span>
    .<span style=color:#a6e22e>createOffer</span>()
    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>sdp</span> =&gt; <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>setLocalDescription</span>(<span style=color:#a6e22e>sdp</span>))
    .<span style=color:#a6e22e>then</span>(() =&gt; {
      <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;offer&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>localDescription</span>);
    });
});

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;candidate&#34;</span>, (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>candidate</span>) =&gt; {
  <span style=color:#a6e22e>peerConnections</span>[<span style=color:#a6e22e>id</span>].<span style=color:#a6e22e>addIceCandidate</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RTCIceCandidate</span>(<span style=color:#a6e22e>candidate</span>));
});

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;disconnectPeer&#34;</span>, <span style=color:#a6e22e>id</span> =&gt; {
  <span style=color:#a6e22e>peerConnections</span>[<span style=color:#a6e22e>id</span>].<span style=color:#a6e22e>close</span>();
  <span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>peerConnections</span>[<span style=color:#a6e22e>id</span>];
});

window.<span style=color:#a6e22e>onunload</span> <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>onbeforeunload</span> <span style=color:#f92672>=</span> () =&gt; {
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>close</span>();
};

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>gotStream</span>(<span style=color:#a6e22e>stream</span>) {
  window.<span style=color:#a6e22e>stream</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>stream</span>;
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;broadcaster&#34;</span>);
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleError</span>(<span style=color:#a6e22e>error</span>) {
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error: &#34;</span>, <span style=color:#a6e22e>error</span>);
}</code></pre></div>
<h3 id=visning-i-browser>Visning i browser</h3>
<p>Javascript koden kan ikke stå alene.
For at kunne eksekvere den i browseren bliver den indsat på en simpel web side i filen <code>public/broadcast/index.html</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
  &lt;<span style=color:#f92672>head</span>&gt;
    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span> /&gt;
    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;viewport&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;width=device-width, initial-scale=1.0&#34;</span>&gt;
    &lt;<span style=color:#f92672>title</span>&gt;Video stream - Broadcaster&lt;/<span style=color:#f92672>title</span>&gt;
<span style=display:block;width:100%;background-color:#3c3d38>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/p5lib/p5.min.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span><span style=display:block;width:100%;background-color:#3c3d38>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/p5lib/p5.sound.min.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span><span style=display:block;width:100%;background-color:#3c3d38>    &lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;stylesheet&#34;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/css&#34;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;../styles.css&#34;</span>&gt;
</span>  &lt;/<span style=color:#f92672>head</span>&gt;
  &lt;<span style=color:#f92672>body</span>&gt;
    &lt;<span style=color:#f92672>h1</span>&gt;Video stream - Broadcaster&lt;/<span style=color:#f92672>h1</span>&gt;
<span style=display:block;width:100%;background-color:#3c3d38>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sketch.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span>
<span style=display:block;width:100%;background-color:#3c3d38>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/socket.io/socket.io.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span><span style=display:block;width:100%;background-color:#3c3d38>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webrtc.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span>  &lt;/<span style=color:#f92672>body</span>&gt;
&lt;/<span style=color:#f92672>html</span>&gt;</code></pre></div>
<p>Bemærk at filen <a href=https://socket.io/docs/v3/client-installation/#Installation>/socket.io/socket.io.js</a> genereres automatisk af serveren når socket.io pakken benyttes.</p>
<p>For at kunne tegne på canvas med <a href=//p5js.org>p5js</a> i <code>public/broadcast/sketch.js</code> er det nødvendigt at inkludere p5 biblioteksfilerne.
Disse er placeret i <code>public/p5lib</code>.</p>
<ul>
<li><a href=demo/public/p5lib/p5.min.js>public/p5lib/p5.min.js</a></li>
<li><a href=demo/public/p5lib/p5.sound.min.js>public/p5lib/p5.sound.min.js</a></li>
</ul>
<p>Der benyttes også en smule css som placeres i <code>public/styles.css</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=color:#f92672>html</span><span style=color:#f92672>,</span> <span style=color:#f92672>body</span> {
  <span style=color:#66d9ef>margin</span>: <span style=color:#ae81ff>0</span>;
  <span style=color:#66d9ef>padding</span>: <span style=color:#ae81ff>0</span>;
}

<span style=color:#f92672>canvas</span> {
  <span style=color:#66d9ef>display</span>: <span style=color:#66d9ef>block</span>;
}

<span style=color:#f92672>video</span> {
  <span style=color:#66d9ef>width</span>: <span style=color:#ae81ff>400</span><span style=color:#66d9ef>px</span>;
  <span style=color:#66d9ef>height</span>: <span style=color:#ae81ff>400</span><span style=color:#66d9ef>px</span>;
  <span style=color:#66d9ef>background-color</span>: <span style=color:#66d9ef>black</span>;
}</code></pre></div>
<h2 id=modtager-af-video-stream>Modtager af video stream</h2>
<p>Den modtagende ende af videostrømmen laves også som en simpel webside.
Det er den man skal se, når man besøger serveren.</p>
<p>Lav filen <code>public/index.html</code> med dette indhold.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
  &lt;<span style=color:#f92672>head</span>&gt;
    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span> /&gt;
    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;viewport&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;width=device-width, initial-scale=1.0&#34;</span>&gt;
    &lt;<span style=color:#f92672>title</span>&gt;Video stream - Viewer&lt;/<span style=color:#f92672>title</span>&gt;
    &lt;<span style=color:#f92672>link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/styles.css&#34;</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;stylesheet&#34;</span> /&gt;
  &lt;/<span style=color:#f92672>head</span>&gt;
  &lt;<span style=color:#f92672>body</span>&gt;
    &lt;<span style=color:#f92672>h1</span>&gt;Video stream - Viewer&lt;/<span style=color:#f92672>h1</span>&gt;
    &lt;<span style=color:#f92672>video</span> <span style=color:#a6e22e>playsinline</span> <span style=color:#a6e22e>autoplay</span> <span style=color:#a6e22e>muted</span>&gt;&lt;/<span style=color:#f92672>video</span>&gt;
    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/socket.io/socket.io.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
<span style=display:block;width:100%;background-color:#3c3d38>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/watch.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span>  &lt;/<span style=color:#f92672>body</span>&gt;
&lt;/<span style=color:#f92672>html</span>&gt;</code></pre></div>
<p>Til at styre modtagelsen af WebRTC strømmen benyttes scriptet <code>public/watch.js</code> med dette indhold.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>peerConnection</span>;
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>iceServers</span><span style=color:#f92672>:</span> [
      { 
        <span style=color:#e6db74>&#34;urls&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;stun:stun.l.google.com:19302&#34;</span>,
      },
      <span style=color:#75715e>// { 
</span><span style=color:#75715e></span>      <span style=color:#75715e>//   &#34;urls&#34;: &#34;turn:TURN_IP?transport=tcp&#34;,
</span><span style=color:#75715e></span>      <span style=color:#75715e>//   &#34;username&#34;: &#34;TURN_USERNAME&#34;,
</span><span style=color:#75715e></span>      <span style=color:#75715e>//   &#34;credential&#34;: &#34;TURN_CREDENTIALS&#34;
</span><span style=color:#75715e></span>      <span style=color:#75715e>// }
</span><span style=color:#75715e></span>  ]
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>socket</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>connect</span>(window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>origin</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>video</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#34;video&#34;</span>);

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;offer&#34;</span>, (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>description</span>) =&gt; {
  <span style=color:#a6e22e>peerConnection</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RTCPeerConnection</span>(<span style=color:#a6e22e>config</span>);
  <span style=color:#a6e22e>peerConnection</span>
    .<span style=color:#a6e22e>setRemoteDescription</span>(<span style=color:#a6e22e>description</span>)
    .<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>createAnswer</span>())
    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>sdp</span> =&gt; <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>setLocalDescription</span>(<span style=color:#a6e22e>sdp</span>))
    .<span style=color:#a6e22e>then</span>(() =&gt; {
      <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;answer&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>localDescription</span>);
    });
  <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>ontrack</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span> =&gt; {
    <span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>srcObject</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>streams</span>[<span style=color:#ae81ff>0</span>];
  };
  <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>onicecandidate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span> =&gt; {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>candidate</span>) {
      <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;candidate&#34;</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>candidate</span>);
    }
  };
});

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;candidate&#34;</span>, (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>candidate</span>) =&gt; {
  <span style=color:#a6e22e>peerConnection</span>
    .<span style=color:#a6e22e>addIceCandidate</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RTCIceCandidate</span>(<span style=color:#a6e22e>candidate</span>))
    .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>e</span> =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>e</span>));
});

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;connect&#34;</span>, () =&gt; {
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;watcher&#34;</span>);
});

<span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;broadcaster&#34;</span>, () =&gt; {
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#34;watcher&#34;</span>);
});

window.<span style=color:#a6e22e>onunload</span> <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>onbeforeunload</span> <span style=color:#f92672>=</span> () =&gt; {
  <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>close</span>();
  <span style=color:#a6e22e>peerConnection</span>.<span style=color:#a6e22e>close</span>();
};</code></pre></div>
<h2 id=afprøvning>Afprøvning</h2>
<p>Nu burde du kunne start serveren med kommandoen.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>npm start</code></pre></div>
<p>For at starte transmissionen skal åbne <a href=http://localhost:4000/broadcast>http://localhost:4000/broadcast</a>.</p>
<p>Hvis du derefter besøger <a href=http://localhost:4000>http://localhost:4000</a> i et andet browservindue, kan du se en video transmission af din sketch.</p>
<figure><img src=screenshot-webrtc-rx-tx.png alt="Screenshot af to browserviduer."><figcaption>
<h4>Screenshot af de to browserviduer med sender og modtager.</h4>
</figcaption>
</figure>
<p>Bemærk at videoen stopper, hvis du lukker det første browservindue. Den burde starte igen, næste gang du besøger <a href=http://localhost:4000/broadcast>http://localhost:4000/broadcast</a>.</p>
<h3 id=materiale>Materiale</h3>
<ul>
<li><a href=https://nodejs.org/en/>Node</a></li>
<li><a href=https://www.npmjs.com/>npm - Node Package Manager</a></li>
<li><a href=http://socket.io/>Socket.io</a></li>
<li><a href=https://socket.io/docs/v3/>Socket.io Version3 Documentation</a></li>
<li><a href=https://socket.io/get-started/chat/>Socket.io - Get started</a></li>
<li><a href=http://expressjs.com/>Express</a></li>
<li><a href=https://www.npmjs.com/package/express>express - nmp package</a></li>
<li><a href=https://webrtc.org/>WebRTC</a></li>
<li><a href=https://p5js.org/>p5.js</a></li>
<li><a href=https://p5js.org/get-started/>p5js getting started</a></li>
<li><a href=https://p5js.org/reference/>p5js reference</a></li>
</ul>
<footer class=footline>
</footer>
</div>
</div>
<div id=navigation>
<a class="nav nav-prev" href=/tech/node/web-server/ title="Web Server"> <i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/tech/node/readline-stdin/ title="Readline on Stdin" style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1634592700></script>
<script src=/js/perfect-scrollbar.min.js?1634592700></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1634592700></script>
<script src=/js/jquery.sticky.js?1634592700></script>
<script src=/js/featherlight.min.js?1634592700></script>
<script src=/js/highlight.pack.js?1634592700></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/js/modernizr.custom-3.6.0.js?1634592700></script>
<script src=/js/learn.js?1634592700></script>
<script src=/js/hugo-learn.js?1634592700></script>
<script src=/mermaid/mermaid.js?1634592700></script>
<script>mermaid.initialize({startOnLoad:!0})</script>
</body>
</html>